<!DOCTYPE html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
    <title>Viewing Project</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'Nav.html', true);
        xhr.onload = function () {
            if (xhr.status == 200) {
                console.log("Nav.html loaded successfully");
                $("#includedNavContent").html(xhr.responseText);
            } else {
                console.error("Error loading Nav.html: " + xhr.status);
                $("#includedNavContent").html("Error loading Nav.html");
            }
        };
        xhr.onerror = function () {
            console.error("Request failed");
            $("#includedNavContent").html("Error loading Nav.html");
        };
        xhr.send();
    </script>
</head>

<body>
    <div id="includedNavContent"></div>
    <link rel="stylesheet" type="text/css" href="style.css">

    <div class="ExistingProjectPage-Center">
        <div class="ExistingProjectPage-Image">
            <img id="projectImage" src="Assets/example_image.png" alt="Placeholder image" width="380px" height="380px">
        </div>

        <div class="EP-RightContainer-Original">
            <form>
                <div id="EP_N_input">
                    <h3 id="projectName">Name</h3>
                </div>
                <div id="EP_Des_input">
                    <h3 id="projectDescription">Description</h3>
                </div>
            </form>
            
            <div class="ExistingProjectPage-Scroll">
                <h3>Chat Log:</h3>
                <ul id="chatLogList"></ul>
            </div>
            
            <textarea id="messageInput" placeholder="Type your message here..."></textarea>
            <button id="sendMessageBtn">Send Message</button>
            
            <button id="ExistingProjectPage-Create-New">Create New Chat</button>
            
            <div class="ExistingProjectPage-ButtonContainer">
                <button id="ExistingProjectPage-Button" onclick="myFunction()">Edit</button>
                <button id="ExistingProjectPage-Button" onclick="deleteProject()">Delete</button>
            </div>
        </div>

        <div id="EP-RightContainer-EditVersion" class="EP-RightContainer-EditVersion" style="display: none;">
            <form>
                <input id="EP_N_input_Edit" placeholder="Name..">
                <input id="EP_D_input_Edit" placeholder="Description">
            </form>
            
            <div class="ExistingProjectPage-Scroll">
                <h3>Chat Log:</h3>
                <ul id="chatLogList"></ul>
            </div>
            
            <div class="ExistingProjectPage-ButtonContainer">
                <button id="EP-Button-EditVer" onclick="exitEditMode()">Exit</button>
                <button id="EP-Button-EditVer" onclick="saveChanges()">Save</button>
                <button id="EP-Button-EditVer" onclick="deleteProject()">Delete</button>
            </div>
        </div>
    </div>

    <div id="EP-DeleteContainer">
        <h3 id="EP-Delete-Question">Do you want to delete Chatbox for (projectname)?</h3>
        <button id="EP-Button-DeleteVer" onclick="document.location='index.html'">Yes</button>
        <button id="EP-Button-DeleteVer" onclick="document.location='ExistingProjectPage.html'">No</button>
    </div>

    <div id="EP-DeleteChatLog-Container" style="display: none;">
        <h3 id="EP-Delete-Question">Do you want to delete ChatLog for (projectname)?</h3>
        <button id="EP-Button-Delete-Yes" onclick="document.location='ExistingProjectPage.html'">Yes</button>
        <button id="EP-Button-Delete-No" onclick="document.location='ExistingProjectPage.html'">No</button>
    </div>

    <script>
        let selectedProjectName = 'project1'; // Replace with actual project name

        function loadProjectData(projectName, callback) {
            fetch(`http://localhost:3000/files/${projectName}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('projectName').textContent = data.name;
                    document.getElementById('projectDescription').textContent = data.description;

                    if (data.image) {
                        document.getElementById('projectImage').src = `Assets/${data.image}`;
                    }

                    callback(data.name);
                })
                .catch(error => console.error('Error loading project data:', error));
        }

        function loadChatLogs(projectName) {
            fetch(`http://localhost:3000/api/chat/get-messages?projectName=${projectName}`)
                .then(response => response.json())
                .then(messages => {
                    const chatLogList = document.getElementById("chatLogList");
                    chatLogList.innerHTML = "";

                    messages.forEach((msg) => {
                        const logItem = document.createElement("li");
                        logItem.textContent = `[${msg.timestamp}] ${msg.sender}: ${msg.text}`;
                        chatLogList.appendChild(logItem);
                    });
                })
                .catch(error => console.error("Error loading chat logs:", error));
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadProjectData(selectedProjectName, loadChatLogs);
        });

        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            const newMessage = {
                sender: "User",
                text: messageText,
                timestamp: new Date().toISOString()
            };

            fetch("http://localhost:3000/api/chat/save-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    projectName: selectedProjectName,
                    newMessage: newMessage
                })
            })
            .then(response => response.json())
            .then(() => {
                loadChatLogs(selectedProjectName); // Refresh chat log
                messageInput.value = ""; // Clear input
            })
            .catch(error => console.error("Error saving message:", error));
        }

        document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);

        function myFunction() {
            document.querySelector(".EP-RightContainer-Original").style.display = "none";
            document.getElementById("EP-RightContainer-EditVersion").style.display = "block";
        }

        function exitEditMode() {
            document.querySelector(".EP-RightContainer-Original").style.display = "block";
            document.getElementById("EP-RightContainer-EditVersion").style.display = "none";
        }

        function saveChanges() {
            const newName = document.getElementById('EP_N_input_Edit').value;
            const newDescription = document.getElementById('EP_D_input_Edit').value;

            fetch('http://localhost:3000/api/chat/update-project', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    oldName: selectedProjectName,
                    newName: newName,
                    newDescription: newDescription
                })
            })
            .then(() => {
                alert('Project updated successfully!');
                loadProjectData(newName, loadChatLogs);
            })
            .catch(error => console.error('Error saving changes:', error));
        }
    </script>
</body>

<footer>
    <script>
        var xhr1 = new XMLHttpRequest();
        xhr1.open('GET', 'Footer.html', true);
        xhr1.onload = function () {
            if (xhr1.status == 200) {
                console.log("Footer.html loaded successfully");
                $("#includedContent").html(xhr1.responseText);
            } else {
                console.error("Error loading Footer.html: " + xhr1.status);
                $("#includedContent").html("Error loading Footer.html");
            }
        };
        xhr1.onerror = function () {
            console.error("Request failed");
            $("#includedContent").html("Error loading Footer.html");
        };
        xhr1.send();
    </script>
    <div id="includedContent"></div>
</footer>

</html>
